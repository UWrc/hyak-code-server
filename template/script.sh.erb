#!/usr/bin/env bash

<%
# Set our working directory.
working_dir = Pathname.new(context.working_dir)

# Ensure that code-server always starts up in either a user defined directory or the home directory.
if !working_dir.exist?
    working_dir = Pathname.new(ENV['HOME'])
elsif working_dir.file?
    working_dir = working_dir.parent
end
%>

# Create config file for code-server
cat > <%= working_dir %>/.config/code-server/config.yaml <<END
bind-addr: 127.0.0.1:8080
auth: password
password: ${password}
cert: false
END

# Set working directory as default
cat > <%= working_dir %>/.local/share/code-server/coder.json <<END
{
  "query": {
    "folder": "<%= working_dir %>"
  }
}
END

# Configure SSH in VS Code
cat > <%= working_dir %>/.vscode/settings.json <<END
{
    "terminal.integrated.profiles.linux": {
        "apptainer": {
            "path": "ssh",
            "icon": "terminal-bash",
            "args": [
                "-o StrictHostKeyChecking=no",
                "localhost",
            ]
        },
    },
    "terminal.integrated.defaultProfile.linux": "apptainer"
}
END

# Launch code-server Server:
echo "Starting code-server..."
export PASSWORD=${password}

apptainer exec --cleanenv --home <%= working_dir %> ${CODESERVER_APPTAINER_IMAGE} \
    /app/code-server/bin/code-server \
    --bind-addr=${HOSTNAME}:${port} \
    --auth=password \
    --disable-telemetry \
    --disable-update-check